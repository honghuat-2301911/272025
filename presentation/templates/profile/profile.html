<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    {% include 'navbar.html' %}
    <div class="profile-banner">
        <div class="profile-header">
            <img id="profilePicView" src="{{ user.profile_picture or url_for('static', filename='icons/user.png') }}" class="profile-avatar" alt="Profile Picture" style="cursor:pointer;">
            <div class="profile-header-info">
                <h2>{{ user.name}}</h2>
                <p>{{ user.email}}</p>
            </div>
        </div>
    </div>
    <nav class="profile-nav">
        <a href="#" class="active" id="profileTab">Profile</a>
        <a href="#" id="feedTab">Social Feed</a>
        <a href="#" id="activitiesTab">Sports Activities</a>
    </nav>
    <div id="profileSection" class="profile-section">
        <div class="profile-feed">
            <h3>User Profile</h3>
            <div class="profile-feed-item">
                <img src="{{ user.profile_picture or url_for('static', filename='icons/user.png') }}" class="feed-avatar" alt="Profile Picture">
                <div class="feed-content">
                    <p><strong>Name:</strong> {{ user.name}}</p>
                    <p><strong>Email:</strong> {{ user.email}}</p>

                </div>
                <button id="editProfileBtn" class="icon-btn" title="Edit Profile">
                    <img src="{{ url_for('static', filename='icons/edit.png') }}" alt="Edit" class="edit-icon">
                </button>
            </div>
            <!-- 2FA Status Section -->
            <div class="profile-feed-item">
                <div class="feed-content">
                    <p>
                        <strong>2FA Status:</strong>
                        {% if user.otp_enabled %}
                            <span style="color: green; font-weight: bold;">Enabled</span>
                        {% else %}
                            <span style="color: red; font-weight: bold;">Disabled</span>
                        {% endif %}
                    </p>
                    {% if not user.otp_enabled %}
                        <button id="enable2faBtn" class="btn btn-primary">Enable 2FA</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div id="feedSection" class="profile-section" style="display:none;">
        <div class="profile-feed">
            <h3>My Social Feed</h3>
            {% if posts and posts|length > 0 %}
                {% for post in posts %}
                    <form id="deletePostForm-{{ post.id }}" action="{{ url_for('profile_bp.delete_post', post_id=post.id) }}" method="POST" style="display:none;"></form>
                    <div class="profile-feed-item" data-post-id="{{ post.id }}">
                        <img src="{{ user.profile_picture or url_for('static', filename='icons/user.png') }}" class="feed-avatar" alt="Avatar">
                        <div class="feed-content">
                            <p class="post-content">{{ post.content }}</p>
                            {% if post.image_url %}
                                <img src="{{ post.image_url }}" alt="Post Image" class="post-image" style="max-width: 100%; margin-top: 8px; border-radius: 8px;" />
                            {% endif %}
                            <span class="feed-timestamp">{{ post.created_at }}</span>
                        </div>
                        <button class="icon-btn edit-post-btn" title="Edit Post" data-post-id="{{ post.id }}" data-post-content="{{ post.content|e }}">
                            <img src="{{ url_for('static', filename='icons/edit.png') }}" alt="Edit" class="edit-icon">
                        </button>
                        <button class="icon-btn delete-post-btn" title="Delete Post" data-post-id="{{ post.id }}">
                            <img src="{{ url_for('static', filename='icons/delete.png') }}" alt="Delete" class="edit-icon">
                        </button>
                    </div>
                {% endfor %}
            {% else %}
                <p style="text-align:center;">You have not posted anything yet.</p>
            {% endif %}
        </div>
    </div>
    <div id="activitiesSection" class="profile-section" style="display:none;">
        <div class="profile-feed">
            <h3>Sports Activities</h3>
            <div class="activity-group">
                <h4>Hosted Activities ({{ hosted_activities|length }})</h4><br>
                {% if hosted_activities|length > 0 %}
                    {% for activity in hosted_activities %}
                        <div class="profile-feed-item" data-activity-id="{{ activity.id }}-{{ activity.date }}">
                            <img src="{{ user.profile_picture or url_for('static', filename='icons/user.png') }}" class="feed-avatar" alt="Profile Picture">
                            <div class="feed-content">
                                <p><strong>{{ activity.activity_name }}</strong></p>
                                <p>Type: {{ activity.activity_type }}</p>
                                <p>Skills Required: {{ activity.skills_req }}</p>
                                <p>Date: {{ activity.date }}</p>
                                <p>Location: {{ activity.location }}</p>
                                <p>Max Participants: {{ activity.max_pax }}</p>
                            </div>
                            <button class="icon-btn edit-activity-btn" title="Edit Activity" data-activity-id="{{ activity.id }}">
                                <img src="{{ url_for('static', filename='icons/edit.png') }}" alt="Edit" class="edit-icon">
                            </button>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="profile-feed-item">
                        <div class="feed-content">
                            <p>You have not hosted any activities yet.</p>
                        </div>
                    </div>
                {% endif %}
            </div>
            <div class="activity-group">
                <h4>Joined Activities ({{ joined_only_activities|length }})</h4><br>
                {% if joined_only_activities|length > 0 %}
                    {% for activity in joined_only_activities %}
                        <div class="profile-feed-item" data-activity-id="{{ activity.id }}-{{ activity.date }}">
                            <img src="{{ user.profile_picture or url_for('static', filename='icons/user.png') }}" class="feed-avatar" alt="Profile Picture">
                            <div class="feed-content">
                                <p><strong>{{ activity.activity_name }}</strong></p>
                                <p>Type: {{ activity.activity_type }}</p>
                                <p>Skills Required: {{ activity.skills_req }}</p>
                                <p>Date: {{ activity.date }}</p>
                                <p>Location: {{ activity.location }}</p>
                                <p>Max Participants: {{ activity.max_pax }}</p>
                            </div>
                            <!-- Leave Activity Button triggers modal -->
                            <button type="button" class="icon-btn leave-activity-btn" data-activity-id="{{ activity.id }}" title="Leave Activity">
                                <img src="{{ url_for('static', filename='icons/delete.png') }}" alt="Leave" class="edit-icon">
                            </button>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="profile-feed-item">
                        <div class="feed-content">
                            <p>You have not joined any activities yet.</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Modal for editing profile -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModalBtn">&times;</span>
            <h3>Edit Profile</h3>
            <form class="profile-edit-form" id="profileEditForm" method="POST" action="{{ url_for('profile_bp.editProfile') }}" enctype="multipart/form-data">
                <div>
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" value="{{ user.name }}" required>
                </div>
                <div>
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" value="{{ user.email}}" required disabled>
                </div>
                <div>
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" placeholder="Enter new password">
                </div>
                <div>
                    <label for="profile_picture">Profile Picture:</label><br>
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture }}" alt="Current Profile Picture" style="max-width: 100px; border-radius: 8px; margin-bottom: 8px;" />
                    {% endif %}
                    <input type="file" id="profile_picture" name="profile_picture" accept="image/*">
                    <br>
                    <label><input type="checkbox" name="remove_profile_picture"> Remove current profile picture</label>
                </div>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>
    <!-- Modal for enabling 2FA -->
    <div id="enable2faModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close2faModalBtn">&times;</span>
            <h3>Enable Two-Factor Authentication</h3>
            
            <!-- QR Code Section -->
            <div id="qr2faSection">
                <p>Scan this QR code with Google Authenticator:</p>
                <img id="qr2faImg" src="" alt="2FA QR Code" style="margin: 16px auto; display: block; max-width: 200px;">
                <p id="otpSecretText" style="font-size: small; color: #888;"></p>
            </div>
            
            <!-- Success Section (hidden initially) -->
            <div id="success2faSection" style="display:none; text-align:center;">
                <p style="color:green; font-weight:bold;">✅ 2FA Enabled Successfully!</p>
                <p>You can now log in with your authenticator app</p>
            </div>
            
            <button id="done2faBtn" style="display:none; margin-top: 16px;">Done</button>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div id="editPostModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeEditPostModalBtn">&times;</span>
            <h3>Edit Post</h3>
            <form id="editPostForm" method="POST" enctype="multipart/form-data">
                <input type="hidden" id="editPostId" name="post_id">
                <div>
                    <label for="editPostContent">Content:</label>
                    <textarea id="editPostContent" name="content" rows="4" style="width:100%;"></textarea>
                </div>
                <div id="editPostImageSection" style="display:none; margin-top:10px;">
                    <div id="currentPostImageContainer"></div>
                    <label>
                        <input type="checkbox" id="removeImageCheckbox" name="remove_image"> Remove image from post
                    </label>
                </div>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>
    <!-- Delete Post Modal -->
    <div id="deletePostModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeDeletePostModalBtn">&times;</span>
            <h3>Delete Post</h3>
            <p>Are you sure you want to delete this post?</p>
            <div class="delete-modal-actions">
                <button id="confirmDeletePostBtn" class="delete-confirm-btn">Yes, Delete</button>
                <button id="cancelDeletePostBtn" class="cancel-confirm-btn">Cancel</button>
            </div>
        </div>
    </div>
    <!-- Edit Activity Modal -->
    <div id="editActivityModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeEditActivityModalBtn">&times;</span>
            <h3>Edit Activity</h3>
            <form id="editActivityForm" method="POST">
                <input type="hidden" id="editActivityId" name="activity_id">
                <div>
                    <label for="editActivityName">Activity Name:</label>
                    <input type="text" id="editActivityName" name="activity_name" style="width:100%;" required>
                </div>
                <div>
                    <label for="editActivityType">Type:</label>
                    <select id="editActivityType" name="activity_type" class="profile-input" style="width:100%;" required>
                        <option value="Sports">Sports</option>
                        <option value="Non Sports">Non Sports</option>
                    </select>
                </div>
                <div>
                    <label for="editSkillsReq">Skills Required:</label>
                    <input type="text" id="editSkillsReq" name="skills_req" style="width:100%;" required>
                </div>
                <div>
                    <label for="editActivityDate">Date:</label>
                    <input type="datetime-local" id="editActivityDate" name="date" class="profile-input" style="width:100%;" required>
                </div>
                <div>
                    <label for="editActivityLocation">Location:</label>
                    <input type="text" id="editActivityLocation" name="location" style="width:100%;" required>
                </div>
                <div>
                    <label for="editActivityMaxPax">Max Participants:</label>
                    <input type="number" id="editActivityMaxPax" name="max_pax" style="width:100%;" required>
                </div>
                <button type="submit" class="delete-confirm-btn" style="margin-top:18px;">Save Changes</button>
            </form>
        </div>
    </div>
    <!-- Hidden Leave Activity Form -->
    <form id="leaveActivityForm" method="POST" style="display:none;"></form>
    <!-- Leave Activity Modal -->
    <div id="leaveActivityModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeLeaveActivityModalBtn">&times;</span>
            <h3>Leave Activity</h3>
            <p>Are you sure you want to leave this activity?</p>
            <div class="delete-modal-actions">
                <button id="confirmLeaveActivityBtn" class="delete-confirm-btn" type="button">Yes, Leave</button>
                <button id="cancelLeaveActivityBtn" class="cancel-confirm-btn" type="button">Cancel</button>
            </div>
        </div>
    </div>
    <!-- Profile Picture Modal -->
    <div id="profilePicModal" class="modal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;">
        <span class="close-modal" onclick="closeProfilePicModal()" style="position:absolute;top:32px;right:48px;font-size:2.5em;color:#fff;cursor:pointer;z-index:10001;">&times;</span>
        <img id="profilePicModalImg" src="" alt="Profile Picture" style="max-width:90vw;max-height:80vh;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.4);background:#fff;">
    </div>
    <script>
        // Tab switching logic
        document.getElementById('profileTab').onclick = function() {
            showSection('profileSection', this);
        };
        document.getElementById('feedTab').onclick = function() {
            showSection('feedSection', this);
        };
        document.getElementById('activitiesTab').onclick = function() {
            showSection('activitiesSection', this);
        };
        function showSection(sectionId, tab) {
            document.querySelectorAll('.profile-section').forEach(s => s.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
            document.querySelectorAll('.profile-nav a').forEach(a => a.classList.remove('active'));
            tab.classList.add('active');
        }
        // Modal logic
        const editBtn = document.getElementById('editProfileBtn');
        const modal = document.getElementById('editProfileModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        if (editBtn) {
            editBtn.onclick = function() {
                modal.style.display = 'block';
            };
        }
        if (closeModalBtn) {
            closeModalBtn.onclick = function() {
                modal.style.display = 'none';
            };
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Edit Post Modal logic
        const editPostModal = document.getElementById('editPostModal');
        const closeEditPostModalBtn = document.getElementById('closeEditPostModalBtn');
        let currentEditPostId = null;
        document.querySelectorAll('.edit-post-btn').forEach(btn => {
            btn.onclick = function() {
                currentEditPostId = this.getAttribute('data-post-id');
                const postDiv = document.querySelector('.profile-feed-item[data-post-id="' + currentEditPostId + '"]');
                document.getElementById('editPostId').value = currentEditPostId;
                document.getElementById('editPostContent').value = this.getAttribute('data-post-content');
                // Show remove image checkbox and current image if post has image
                const postImage = postDiv.querySelector('.post-image');
                const imageSection = document.getElementById('editPostImageSection');
                const currentImageContainer = document.getElementById('currentPostImageContainer');
                if (postImage) {
                    imageSection.style.display = 'block';
                    document.getElementById('removeImageCheckbox').checked = false;
                    // Show the current image in the modal
                    currentImageContainer.innerHTML = `<img src="${postImage.src}" alt="Current Image" style="max-width: 200px; display:block; margin-bottom:8px;">`;
                } else {
                    imageSection.style.display = 'none';
                    currentImageContainer.innerHTML = '';
                }
                document.getElementById('editPostForm').action = '/profile/edit_post/' + currentEditPostId;
                editPostModal.style.display = 'block';
            };
        });
        if (closeEditPostModalBtn) {
            closeEditPostModalBtn.onclick = function() {
                editPostModal.style.display = 'none';
            };
        }
        window.onclick = function(event) {
            if (event.target == editPostModal) {
                editPostModal.style.display = 'none';
            }
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Modal logic for 2FA Enablement
        const enable2faBtn = document.getElementById('enable2faBtn');
        const enable2faModal = document.getElementById('enable2faModal');
        const close2faModalBtn = document.getElementById('close2faModalBtn');
        let pollingInterval = null;  // Track polling state

        if (enable2faBtn) {
            enable2faBtn.onclick = function() {
                enable2faModal.style.display = 'block';
                
                // Reset modal state
                document.getElementById('qr2faSection').style.display = 'block';
                document.getElementById('success2faSection').style.display = 'none';
                document.getElementById('done2faBtn').style.display = 'none';
                
                // Fetch QR code from backend
                fetch('/profile/generate-otp', {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('qr2faImg').src = data.qr;
                        document.getElementById('otpSecretText').textContent = "Secret: " + data.secret;
                        // Start polling for OTP status
                        startPolling();
                    })
                    .catch(error => {
                        console.error('Error fetching OTP:', error);
                        alert('Failed to generate OTP setup. Please try again.');
                    });
            };
        }

        if (close2faModalBtn) {
            close2faModalBtn.onclick = function() {
                enable2faModal.style.display = 'none';
                stopPolling();  // Stop polling when modal closes
            };
        }

        // Add to existing window.onclick handler
        window.onclick = function(event) {
            // ... your existing conditions ...
            if (event.target == enable2faModal) {
                enable2faModal.style.display = 'none';
                stopPolling();  // Stop polling when clicking outside
            }
        };

        // Start polling with cleanup
        function startPolling() {
            stopPolling();  // Clear any existing polling
            pollOtpStatus();
        }

        function stopPolling() {
            if (pollingInterval) {
                clearTimeout(pollingInterval);
                pollingInterval = null;
            }
        }

        // Polling function to check OTP status
        function pollOtpStatus() {
            fetch('/profile/check-otp-status')
                .then(response => response.json())
                .then(data => {
                    if (data.otp_enabled) {
                        // Show success message and hide QR
                        document.getElementById('qr2faSection').style.display = 'none';
                        document.getElementById('success2faSection').style.display = 'block';
                        document.getElementById('done2faBtn').style.display = 'inline-block';
                        stopPolling();  // Stop when enabled
                    } else {
                        // Continue polling every 2 seconds
                        pollingInterval = setTimeout(pollOtpStatus, 2000);
                    }
                })
                .catch(error => {
                    console.error('Polling error:', error);
                    pollingInterval = setTimeout(pollOtpStatus, 2000);
                });
        }

        // Done button handler
        document.getElementById('done2faBtn').onclick = function() {
            enable2faModal.style.display = 'none';
            window.location.reload();
        };

        // Delete Post Modal logic
        const deletePostModal = document.getElementById('deletePostModal');
        const closeDeletePostModalBtn = document.getElementById('closeDeletePostModalBtn');
        let currentDeletePostId = null;
        document.querySelectorAll('.delete-post-btn').forEach(btn => {
            btn.onclick = function() {
                const postId = this.getAttribute('data-post-id');
                if (confirm('Are you sure you want to delete this post?')) {
                    document.getElementById('deletePostForm-' + postId).submit();
                }
            };
        });
        if (closeDeletePostModalBtn) {
            closeDeletePostModalBtn.onclick = function() {
                deletePostModal.style.display = 'none';
            };
        }
        document.getElementById('cancelDeletePostBtn').onclick = function() {
            deletePostModal.style.display = 'none';
        };
        document.getElementById('confirmDeletePostBtn').onclick = function() {
            if (currentDeletePostId) {
                // Find the post and change its content to 'Post Deleted'
                const postDiv = document.querySelector('.profile-feed-item[data-post-id="' + currentDeletePostId + '"] .post-content');
                if (postDiv) {
                    postDiv.textContent = 'Post Deleted';
                }
            }
            deletePostModal.style.display = 'none';
        };

        // Edit Activity Modal logic
        const editActivityModal = document.getElementById('editActivityModal');
        const closeEditActivityModalBtn = document.getElementById('closeEditActivityModalBtn');
        let currentEditActivityId = null;
        document.querySelectorAll('.edit-activity-btn').forEach(btn => {
            btn.onclick = function() {
                const activityDiv = this.closest('.profile-feed-item');
                currentEditActivityId = activityDiv ? activityDiv.getAttribute('data-activity-id').split('-')[0] : null;
                // For now, just fill with dummy data from the DOM
                document.getElementById('editActivityId').value = currentEditActivityId;
                document.getElementById('editActivityForm').action = '/profile/edit_activity/' + currentEditActivityId;
                document.getElementById('editActivityName').value = activityDiv.querySelector('p strong').textContent;
                document.getElementById('editActivityType').value = activityDiv.querySelector('p:nth-of-type(2)').textContent.replace('Type: ', '');
                document.getElementById('editSkillsReq').value = activityDiv.querySelector('p:nth-of-type(3)').textContent.replace('Skills Required: ', '');
                document.getElementById('editActivityDate').value = activityDiv.querySelector('p:nth-of-type(4)').textContent.replace('Date: ', '');
                document.getElementById('editActivityLocation').value = activityDiv.querySelector('p:nth-of-type(5)').textContent.replace('Location: ', '');
                document.getElementById('editActivityMaxPax').value = activityDiv.querySelector('p:nth-of-type(6)').textContent.replace('Max Participants: ', '');
                editActivityModal.style.display = 'block';
            };
        });
        if (closeEditActivityModalBtn) {
            closeEditActivityModalBtn.onclick = function() {
                editActivityModal.style.display = 'none';
            };
        }
        document.getElementById('editActivityForm').onsubmit = function(e) {
            // Let the form submit normally (POST to /profile/edit_activity/<id>)
        };

        // Leave Activity Modal logic
        const leaveActivityModal = document.getElementById('leaveActivityModal');
        const closeLeaveActivityModalBtn = document.getElementById('closeLeaveActivityModalBtn');
        let currentLeaveActivityId = null;
        document.querySelectorAll('.leave-activity-btn').forEach(btn => {
            btn.onclick = function() {
                const activityDiv = this.closest('.profile-feed-item');
                currentLeaveActivityId = activityDiv ? activityDiv.getAttribute('data-activity-id').split('-')[0] : null;
                leaveActivityModal.style.display = 'block';
            };
        });
        document.getElementById('confirmLeaveActivityBtn').onclick = function() {
            if (currentLeaveActivityId) {
                const form = document.getElementById('leaveActivityForm');
                form.action = '/profile/leave_activity/' + currentLeaveActivityId;
                form.submit();
            }
            leaveActivityModal.style.display = 'none';
        };
        document.getElementById('cancelLeaveActivityBtn').onclick = function() {
            leaveActivityModal.style.display = 'none';
        };
        if (closeLeaveActivityModalBtn) {
            closeLeaveActivityModalBtn.onclick = function() {
                leaveActivityModal.style.display = 'none';
            };
        }

        window.onload = function() {
            if (window.location.hash === "#activitiesSection") {
                showSection('activitiesSection', document.getElementById('activitiesTab'));
            } else if (window.location.hash === "#feedSection") {
                showSection('feedSection', document.getElementById('feedTab'));
            }
        };

        // Profile Picture Modal Logic
        function closeProfilePicModal() {
            document.getElementById('profilePicModal').style.display = 'none';
        }
        document.getElementById('profilePicView').onclick = function() {
            var modal = document.getElementById('profilePicModal');
            var modalImg = document.getElementById('profilePicModalImg');
            modalImg.src = this.src;
            modal.style.display = 'flex';
        };
        document.getElementById('profilePicModal').onclick = function(e) {
            if (e.target === this) closeProfilePicModal();
        };
    </script>
</body>
</html> 